# 铁路售票系统设计文档

简单的模拟铁路售票系统：

1. 单机C/S系统；
2. 网络C/S系统或B/S系统。

## 程序功能界定

### 1. 注册

1. 用户输入必要的注册信息：用户名（即邮箱），密码进行注册。
2. 用户名必须唯一，若用户名已经存在则提示用户，并要求其更改用户名再注册。
3. 密码需输入两次，若两次不密码不相同则提示用户重新输入密码。
4. 注册完成后系统返回注册成功信息。 

### 2. 登陆

1. 用户凭用户名和密码对在系统进行登陆。
2. 用户名和密码都不能为空，如不符合规范，则提示用户补完输入。
3. 登陆成功，则进入系统，反之提示用户名或密码错误并回到第1步。

### 3. 车票查询

1. 用户登陆后，系统给出欢迎提示，并列出简要的操作指南。
2. 用户按照车票日期，时刻，始发站和目的地中的一个或几个条件的组合查询车票。
3. 系统查询车票，若存在则返回所有结果，若不存在则给出不存在的提示。
4. 用户重复2、3步骤若干次直至选中车票进入订票步骤或直接退出。

### 4. 预订车票

1. 用户选中车票后选择预订。
2. 用户填写预订车票的数量。
3. 用户提交订单。
4. 系统处理订单，返回预订结果。
5. 用户退出订票系统或继续进行购票。

### 5. 系统需求

1. 对服务器所有的动作都有log文件中。它们包括：

    * 所有客户端和服务器的连接记录；
    * 用户的查询请求；
    * 用户的创建；
    * 用户的订票请求；
    * 程序运行中出现的警告，错误。

2. 性能：至少可以同时为100个用户服务；单次请求响应时间，单机版本至多为0.5秒，网络版至多为1.0秒。

3. 系统可水平拓展。

## 人机交互设计

简易模拟铁路售票系统在交互上使用CLI，以会话形式进行交互。交互形式(以登录为例):

    =========================== XXX 功能===========================
    Please enter you user name nad password.
    Username:
    Password:

程序在功能切换时提供选项:

    =========================== Start ===========================
    Welcome!
    1. Log in.
    2. Register.
    3. Exit.
    Your choice is: 



按照功能界定:

    login   登陆;
    logout  登出;
    query   查询;
    order   订票;


## 概要设计 

单机版和网络版的铁路售票系统中，客户端和服务器的通信都以socket为基础。考虑到铁路购票系统需要同时为多个用户服务，有两种思路：

1. 用一个队列把购票者排起来，逐个进行处理；
2. 服务器使用多线程或多进程来同时处理多个请求。

队列形式实现起来相对简单，所有业务都是同步的，不需要在库存管理上多做设计，且几乎不存在进程间通信问题。坏处是一旦用户多起来，平均等待时间将会增加。即使每个用户只用10秒就能订好票，对队列位置靠后的用户来说等待时间也会很长，如第60位用户需要等上10分钟。

第二种设计在用户订票体验和系统效率上很占优势。本模拟铁路购票程序采用第二中设计。当然在设计上需要做更多考量。


### 总体模块划分：

无论是单机版，还是网络版，客户端在模拟铁路售票系统中承担的责任仅仅是“终端”，处理和用户的前台简单交互，向服务器发送请求数据，读取返回数据并呈现给用户，是配角。而服务器则承担了核心业务，接收客户端的服务请求，执行具体的注册、认证、查票、订票事务，维护铁路票的数据库，对用户请求做出回应。

考虑到单机版向网络版过度的平稳性，我们将会把通信模块和业务模块分离。（模块原则、分离原则）

    .
    |-- client
    |   |-- client.c                    客户端程序入口
    |   |-- core.c                      客户端核心，读取用户输入，显示事务结果。
    |   `-- core.h
    |-- common.h
    |-- connection.c                    连接封装，负责请求和回应的封装和拆卸
    |-- connection.h
    |-- defs.h                          定义了request,response等通用的结构
    |-- error.c                         工具，error模块
    |-- error.h
    |-- fifo.c                          FIFO模块，初始化服务器、客户端FIFO，负责建立连接和关闭连接
    |-- fifo.h
    |-- Makefile
    |-- server
    |   |-- database.c                  数据库模块，负责所有和数据库的交互业务
    |   |-- database.h
    |   |-- server.c                    服务器程序入口，（下一版本将引入多进程）
    |   |-- transaction.c               服务器事务模块，处理所有客户端的请求
    |   `-- transaction.h
    |-- socket.c                        socket模块，同FIFO模块接口类似
    `-- socket.h


#### 1. 单机C/S版

单机版客户端和服务器基于FIFO通信。


#### 2. 网络C/S版

网络版客户端和服务器基于socket通信。

### 灵活性和可拓展性

UNIX视一切东西为文件（好吧，almost）。这样的思想在本程序中将得以体现。客户端和服务器将仅仅维护文件描述符。而文件描述符指向的东西到底是FIFO还是socket，这个问题不用关心。他们唯一需要做的就是根据不同的指令，从文件中读，往文件里写。

由于模块分离，单机版向客户端的转变仅需将FIFO模块改成socket模块。其他模块不受影响。
 
要添加新的功能？ 你需要：

1. 完善数据库；
2. 分别在客户端、服务器的core和transaction添加事务代码，（注意参数解析）
3. complie, link and run

